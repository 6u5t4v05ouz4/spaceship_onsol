<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Configura√ß√£o Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Verificar Configura√ß√£o Supabase</h1>
        <p>Esta p√°gina verifica a configura√ß√£o do Supabase e testa a conectividade.</p>
        
        <button onclick="checkConfig()">Verificar Configura√ß√£o</button>
        <button onclick="testConnection()">Testar Conex√£o</button>
        <button onclick="checkTables()">Verificar Tabelas</button>
        <button onclick="clearDebug()">Limpar Debug</button>
        
        <div id="debug" class="debug"></div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="/src/config-legacy.js"></script>
    
    <script>
        // Supabase configuration
        const supabaseConfig = window.appConfig.getSupabaseConfig();
        const supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });
        
        // Debug logging
        function log(message, type = 'info') {
            const debugDiv = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (type === 'error') {
                debugDiv.innerHTML += `<span style="color: red;">${logMessage}</span>`;
            } else if (type === 'success') {
                debugDiv.innerHTML += `<span style="color: green;">${logMessage}</span>`;
            } else {
                debugDiv.innerHTML += logMessage;
            }
            
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        function clearDebug() {
            document.getElementById('debug').innerHTML = '';
        }
        
        // Check configuration
        async function checkConfig() {
            try {
                log('üîç Verificando configura√ß√£o...');
                
                log(`üåê Supabase URL: ${supabaseConfig.url}`);
                log(`üîë Anon Key: ${supabaseConfig.anonKey.substring(0, 20)}...`);
                log(`üè† Hostname: ${window.location.hostname}`);
                log(`üîó Origin: ${window.location.origin}`);
                
                // Check if we're in development
                const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                log(`üõ†Ô∏è Modo Desenvolvimento: ${isDev}`);
                
                // Test basic connection
                const { data, error } = await supabase.from('user_profiles').select('count').limit(1);
                
                if (error) {
                    log(`‚ùå Erro de conex√£o: ${error.message}`, 'error');
                    log(`‚ùå C√≥digo: ${error.code}`);
                    log(`‚ùå Detalhes: ${error.details}`);
                } else {
                    log('‚úÖ Conex√£o com Supabase funcionando', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar configura√ß√£o: ${error.message}`, 'error');
            }
        }
        
        // Test connection
        async function testConnection() {
            try {
                log('üîç Testando conex√£o...');
                
                // Test 1: Basic query
                log('üîÑ Teste 1: Query b√°sica...');
                const { data: test1, error: error1 } = await supabase
                    .from('user_profiles')
                    .select('id')
                    .limit(1);
                
                if (error1) {
                    log(`‚ùå Teste 1 falhou: ${error1.message}`, 'error');
                } else {
                    log('‚úÖ Teste 1 passou', 'success');
                }
                
                // Test 2: Check if table exists
                log('üîÑ Teste 2: Verificar se tabela existe...');
                const { data: test2, error: error2 } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(0);
                
                if (error2) {
                    log(`‚ùå Teste 2 falhou: ${error2.message}`, 'error');
                    if (error2.code === 'PGRST116') {
                        log('üí° Tabela user_profiles n√£o existe ou n√£o √© acess√≠vel', 'error');
                    }
                } else {
                    log('‚úÖ Teste 2 passou - tabela existe', 'success');
                }
                
                // Test 3: Check RLS
                log('üîÑ Teste 3: Verificar RLS...');
                const { data: test3, error: error3 } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(1);
                
                if (error3) {
                    log(`‚ùå Teste 3 falhou: ${error3.message}`, 'error');
                    if (error3.code === '42501') {
                        log('üí° Erro de permiss√£o - RLS pode estar bloqueando', 'error');
                    }
                } else {
                    log('‚úÖ Teste 3 passou - RLS n√£o est√° bloqueando', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao testar conex√£o: ${error.message}`, 'error');
            }
        }
        
        // Check tables
        async function checkTables() {
            try {
                log('üîç Verificando tabelas...');
                
                // List all tables
                const { data, error } = await supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public');
                
                if (error) {
                    log(`‚ùå Erro ao listar tabelas: ${error.message}`, 'error');
                    return;
                }
                
                if (data && data.length > 0) {
                    log('‚úÖ Tabelas encontradas:', 'success');
                    data.forEach(table => {
                        log(`üìã ${table.table_name}`);
                    });
                    
                    // Check if user_profiles exists
                    const userProfilesExists = data.some(table => table.table_name === 'user_profiles');
                    if (userProfilesExists) {
                        log('‚úÖ Tabela user_profiles existe', 'success');
                    } else {
                        log('‚ùå Tabela user_profiles n√£o encontrada', 'error');
                    }
                } else {
                    log('‚ö†Ô∏è Nenhuma tabela encontrada', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao verificar tabelas: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina de verifica√ß√£o carregada');
            log('üí° Clique em "Verificar Configura√ß√£o" para come√ßar');
        });
    </script>
</body>
</html>
