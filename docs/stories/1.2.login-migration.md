# Story 1.2: Migra√ß√£o da Funcionalidade de Login

## Status

Approved

---

## Story

**As a** Usu√°rio,
**I want** poder fazer login usando a interface existente,
**so that** eu possa acessar minha conta na nova estrutura.

---

## Acceptance Criteria

1. ‚úÖ Conte√∫do/funcionalidade de `login.html` migrados para `LoginPage`
2. ‚úÖ Autentica√ß√£o Supabase (email/senha e/ou OAuth) funciona via `LoginPage`
3. ‚úÖ Login redireciona para `/dashboard`
4. ‚úÖ Erros de login tratados e exibidos ao usu√°rio (seguir `UI_UX_DESIGN_SYSTEM.md`)
5. ‚úÖ L√≥gica de autentica√ß√£o encapsulada em `authService.js`
6. ‚úÖ Estados de carregamento (loading) exibidos durante autentica√ß√£o
7. ‚úÖ Testes automatizados (integra√ß√£o/E2E b√°sicos) criados para validar fluxo principal de login
8. ‚úÖ Novos testes de regress√£o passam

---

## Dev Notes

### Previous Story Insights

- **Hist√≥ria 1.1 completada:** Estrutura de pastas (`src/web/`, `src/game/`, `src/shared/`) criada
- **Roteador configurado:** Rota `/login` est√° pronta para receber LoginPage
- **Ponto de entrada:** `src/main.js` j√° gerencia transi√ß√µes de rotas
[Source: 1.1.new-structure-routing.md]

### Autentica√ß√£o Supabase Atual

**Cliente Supabase:**
- Inicializado em `src/supabase-dev.js`
- Configura√ß√£o em `src/config/supabase-config.js`
- Vari√°veis de ambiente: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`

**M√©todos Suportados:**
1. **Email/Senha:** `supabase.auth.signInWithPassword({ email, password })`
2. **OAuth:** `supabase.auth.signInWithOAuth({ provider: 'google' })`
   - Redirect ap√≥s OAuth: `redirectTo: 'http://localhost:3000/auth-callback'`

**Gerenciamento de Sess√£o:**
- JWT tokens armazenados em localStorage (managed by Supabase)
- Refresh autom√°tico antes de expira√ß√£o
- `getSession()` retorna sess√£o atual

[Source: architecture/05-api-specifications.md#autentica√ß√£o, architecture/06-integration-points.md#1-supabase-backend]

### Estrutura HTML Atual (login.html)

**O que migrar:**
- Formul√°rio de email/senha
- Bot√£o(√µes) de OAuth (se existente)
- Estilos CSS associados
- Mensagens de erro/sucesso
- Estados de loading

**Refer√™ncia arquivo:**
- Arquivo: `login.html` (na raiz)
- Este arquivo ser√° backup ap√≥s a migra√ß√£o
[Source: architecture/03-module-organization.md#üåê-arquivos-html-na-raiz]

### Estrutura de Componente LoginPage

**Localiza√ß√£o:** `src/web/pages/LoginPage.js`

**Responsabilidades:**
1. Renderizar formul√°rio de login
2. Capturar dados de entrada (email, senha)
3. Chamar `authService.signIn()`
4. Gerenciar loading state durante requisi√ß√£o
5. Exibir mensagens de erro (amig√°veis)
6. Redirecionar para `/dashboard` ap√≥s sucesso
7. Persistir estado se necess√°rio

**Estrutura B√°sica:**
```javascript
export class LoginPage {
  constructor(router, authService) {
    this.router = router;
    this.authService = authService;
  }

  async render() {
    // Renderizar HTML do formul√°rio
  }

  async handleLogin(email, password) {
    // L√≥gica de login
  }

  handleOAuthLogin(provider) {
    // L√≥gica de OAuth
  }
}
```

### Auth Service (src/shared/services/authService.js)

**Deve encapsular:**
- Inicializa√ß√£o do Supabase
- M√©todos: `signIn()`, `signUp()`, `signOut()`, `getSession()`, `refreshSession()`
- Tratamento de erros
- Armazenamento de tokens (j√° feito pelo Supabase)

**Exemplo:**
```javascript
export async function signIn(email, password) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password,
  });
  
  if (error) throw new Error(error.message);
  return data;
}

export async function signInWithOAuth(provider) {
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider,
    options: { redirectTo: getRedirectUrl() }
  });
  
  if (error) throw new Error(error.message);
  return data;
}
```

[Source: architecture/05-api-specifications.md#autentica√ß√£o]

### Fluxo de Autentica√ß√£o

```
1. Usu√°rio acessa /login
2. LoginPage renderiza formul√°rio
3. Usu√°rio preenche email/senha e clica "Login"
4. LoginPage mostra loading state
5. authService.signIn() faz chamada ao Supabase
6. Supabase retorna { user, session, error }
7. Se sucesso:
   - LoginPage redireciona para /dashboard
   - Session armazenada em localStorage
8. Se erro:
   - LoginPage exibe mensagem de erro amig√°vel
   - Usu√°rio pode tentar novamente
```

[Source: architecture/06-integration-points.md#3-web-ui--supabase]

### Tratamento de Erros

**Erros Esperados do Supabase:**
- `Invalid login credentials` - Email/senha incorretos
- `Email not confirmed` - Email ainda n√£o verificado
- `User not found` - Email n√£o registrado
- `Network error` - Sem conex√£o

**Feedback ao Usu√°rio:**
- Mostrar mensagem clara e amig√°vel (pt-br)
- N√£o expor detalhes t√©cnicos
- Sugerir a√ß√µes (verificar email, tentar novamente, etc)
[Source: architecture/08-testing-reality.md#error-cases]

### UI/UX Guidelines

Seguir `docs/UI_UX_DESIGN_SYSTEM.md` para:
- Paleta de cores
- Tipografia
- Espa√ßamento e layout
- Estados (normal, hover, disabled, error)
- Anima√ß√µes (se houver)
- Acessibilidade (labels, ARIA, etc)

### Testability

**Dados Necess√°rios para Testes:**
- Usu√°rio de teste: `test@example.com` / `password123`
- Vari√°veis de ambiente devem estar configuradas
- Supabase deve estar acess√≠vel
[Source: architecture/08-testing-reality.md#phase-2-integration-tests]

---

## Tasks / Subtasks

- [ ] **Task 1: Criar AuthService** (AC: 5)
  - [ ] Criar arquivo `src/shared/services/authService.js`
  - [ ] Implementar `signIn(email, password)` com Supabase
  - [ ] Implementar `signInWithOAuth(provider)` com redirect correto
  - [ ] Implementar `signOut()`
  - [ ] Implementar `getSession()`
  - [ ] Implementar `refreshSession()`
  - [ ] Adicionar tratamento de erros com mensagens amig√°veis
  - [ ] Exportar fun√ß√µes para uso em componentes

- [ ] **Task 2: Criar LoginPage Component** (AC: 1, 3, 4, 6)
  - [ ] Criar arquivo `src/web/pages/LoginPage.js`
  - [ ] Renderizar formul√°rio HTML com campos: email, senha
  - [ ] Adicionar bot√£o de login (email/senha)
  - [ ] Adicionar bot√£o(√µes) de OAuth (Google, GitHub, etc - se aplic√°vel)
  - [ ] Implementar valida√ß√£o de entrada (email v√°lido, senha n√£o vazia)
  - [ ] Gerenciar loading state durante autentica√ß√£o
  - [ ] Exibir erros amig√°veis se login falhar (AC: 4)
  - [ ] Redirecionar para `/dashboard` ap√≥s sucesso (AC: 3)

- [ ] **Task 3: Integrar LoginPage ao Roteador** (AC: 3)
  - [ ] Registrar rota `/login` em `src/shared/router.js`
  - [ ] Garantir que rota `/login` renderiza LoginPage
  - [ ] Testar navega√ß√£o manual para `/login`

- [ ] **Task 4: Extrair Estilos CSS** (AC: 1)
  - [ ] Copiar/adaptar estilos de `login.html` para `src/styles/pages/login.css`
  - [ ] Ou importar estilos inline em LoginPage.js (escolher abordagem)
  - [ ] Garantir que estilos seguem `UI_UX_DESIGN_SYSTEM.md`
  - [ ] Testar responsividade em desktop e mobile

- [ ] **Task 5: Testar Fluxo de Login Manual** (AC: 2, 3, 4, 6)
  - [ ] `npm run dev` - iniciar servidor
  - [ ] Acessar `localhost:3000/login`
  - [ ] Testar login com credenciais v√°lidas
  - [ ] Verificar redirecionamento para `/dashboard`
  - [ ] Testar com credenciais inv√°lidas
  - [ ] Verificar mensagens de erro
  - [ ] Testar loading states
  - [ ] Se aplic√°vel: testar OAuth (Google/GitHub)

- [ ] **Task 6: Criar Testes de Integra√ß√£o/E2E** (AC: 7)
  - [ ] Configurar Vitest (ou Jest) se n√£o estiver
  - [ ] Criar arquivo `tests/integration/login.spec.js` ou E2E com Playwright
  - [ ] Teste: navega√ß√£o para `/login` renderiza formul√°rio
  - [ ] Teste: login com credenciais v√°lidas redireciona para `/dashboard`
  - [ ] Teste: login com credenciais inv√°lidas mostra erro
  - [ ] Teste: loading state exibido durante autentica√ß√£o
  - [ ] Adicionar mocks de Supabase para testes (n√£o fazer chamadas reais)
  - [ ] Testes devem passar

- [ ] **Task 7: Testes de Regress√£o** (AC: 8)
  - [ ] Executar `npm run build` - sem erros
  - [ ] Executar `npm run preview` - funciona
  - [ ] Testar manualmente: logout ainda funciona (se implementado)
  - [ ] Testar manualmente: session persiste ap√≥s reload da p√°gina
  - [ ] Verificar console do navegador - sem erros/warnings cr√≠ticos
  - [ ] Testar em diferentes navegadores se poss√≠vel (Chrome, Firefox, Safari)

- [ ] **Task 8: Backup e Limpeza** (AC: 1)
  - [ ] Mover `login.html` para `/backup/login.html.bak`
  - [ ] Verificar se h√° refer√™ncias quebradas ap√≥s backup
  - [ ] Atualizar links/documenta√ß√£o se necess√°rio
  - [ ] Commit e push de mudan√ßas

- [ ] **Task 9: Documenta√ß√£o** (AC: todas)
  - [ ] Documentar padr√£o de LoginPage em `src/web/README.md`
  - [ ] Documentar como usar `authService` em componentes
  - [ ] Atualizar arquitetura se necess√°rio
  - [ ] Criar guia de teste para futuros QAs

---

## Testing

### Padr√£o de Testes para esta Hist√≥ria

- **Framework:** Vitest (unit) + Playwright (E2E)
- **Localiza√ß√£o:** `tests/integration/login.spec.js` ou `e2e/login.spec.js`
- **Mocks:** Supabase deve ser mockado para testes automatizados

### Testes Espec√≠ficos Necess√°rios

1. **Teste de Renderiza√ß√£o:**
   - LoginPage renderiza com formul√°rio de email/senha
   - Bot√£o de login existe e √© clic√°vel

2. **Teste de Login V√°lido:**
   - Usu√°rio faz login com credenciais corretas
   - Redireciona para `/dashboard`
   - Session √© armazenada

3. **Teste de Login Inv√°lido:**
   - Credenciais erradas mostram erro
   - Mensagem de erro √© clara e amig√°vel
   - Usu√°rio permanece em `/login`

4. **Teste de Loading State:**
   - Bot√£o de login desativado durante requisi√ß√£o
   - Spinner ou texto "Carregando..." exibido
   - Estado restaurado ap√≥s sucesso/erro

5. **Teste de OAuth (se aplic√°vel):**
   - Clique em bot√£o OAuth inicia flow correto
   - Redirect URI est√° correto para environment

6. **Teste de Regress√£o:**
   - Build sem erros
   - Preview funciona
   - Nenhum console error

[Source: architecture/08-testing-reality.md]

### Checklist Manual de Testes

- [ ] Login email/senha funciona
- [ ] Login com OAuth (Google) funciona (se impl)
- [ ] Erro com credenciais erradas
- [ ] Redirect para dashboard ap√≥s login
- [ ] Loading state vis√≠vel
- [ ] Mensagens de erro claras
- [ ] Styles seguem design system
- [ ] Responsivo em mobile

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story created by Scrum Master | Bob (SM) |

---

## Dev Agent Record

*To be populated during implementation by the development agent.*

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

---

## QA Results

*To be populated by QA Agent after story implementation.*
