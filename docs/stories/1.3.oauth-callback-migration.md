# Story 1.3: Migração e Correção do Callback de Autenticação OAuth

## Status

Draft

---

## Story

**As a** Sistema,
**I want** processar corretamente os redirects de callback do OAuth na nova estrutura de roteamento,
**so that** o login via OAuth funcione e redirecione corretamente no ambiente de desenvolvimento.

---

## Acceptance Criteria

1. ✅ Lógica de `auth-callback.html` migrada para `AuthCallbackPage` na rota `/auth-callback`
2. ✅ Componente captura parâmetros da URL e processa via `authService.js`
3. ✅ Após sucesso, usuário autenticado e redirecionado para `/dashboard`
4. ✅ **BUGFIX:** Redirecionamento após callback OAuth no ambiente `dev` agora direciona para URL de desenvolvimento local (ex: `localhost:3000/dashboard`) e **NÃO** para URL de produção da Vercel
5. ✅ Erros durante callback tratados e exibidos (se aplicável)

---

## Dev Notes

### Previous Story Insights

- **História 1.1 completada:** Estrutura criada, roteador configurado
- **História 1.2 completada:** `authService.js` existe com métodos de autenticação
- **Dependências:** Esta história depende de 1.1 e 1.2 estarem completas
[Source: 1.1.new-structure-routing.md, 1.2.login-migration.md]

### Bug Conhecido: Redirecionamento OAuth em Dev

**Problema:**
- Quando OAuth callback ocorre em ambiente de desenvolvimento (`dev`), o usuário era redirecionado para URL de **produção** (Vercel) ao invés de URL **local** (`localhost:3000`)
- Isso quebrava o fluxo de teste local e causava confusão entre envs

**Causa Raiz:**
- `auth-callback.html` tinha lógica que redirecionava para domínio de produção hardcoded
- `vite.config.js` tinha lógica de rewrite, mas não cobria todos os casos
- Falta de **separação clara entre ambiente dev e prod**

**Solução:**
- Usar variáveis de ambiente: `DEV_REDIRECT_ORIGIN`, `DEV_REDIRECT_PATH`, `DEV_POST_LOGIN_PATH`
- `vite.config.js` já tem suporte parcial para isso (ver arquivo atual)
- `dev-server.cjs` também tem suporte (ver middleware)
- Esta história GARANTE que funcione corretamente

[Source: vite.config.js lines 93-110, dev-server.cjs lines 40-110, epic-1-refactoring.md#história-13]

### OAuth Callback Flow

**Fluxo Esperado:**
```
1. Usuário clica "Login com Google"
2. Supabase redireciona para Google (com redirect_uri = registrado em Supabase)
3. Usuário autentica no Google
4. Google redireciona para: http://localhost:3000/auth-callback (ou config em Supabase)
5. AuthCallbackPage renderiza
6. AuthCallbackPage captura query params: ?code=..., ?state=...
7. AuthCallbackPage chama authService.handleOAuthCallback(code, state)
8. authService valida session com Supabase
9. Se sucesso: redireciona para /dashboard
10. Se erro: exibe mensagem amigável
```

**Configuração Supabase Necessária:**
- Registrar Redirect URI no Supabase OAuth Provider:
  - **Dev:** `http://localhost:3000/auth-callback`
  - **Prod:** `https://space-crypto-miner.vercel.app/auth-callback`

[Source: architecture/05-api-specifications.md#autenticação]

### Arquivo auth-callback.html (Atual)

**O que migrar:**
- Lógica de captura de query params (`?code=`, `?state=`)
- Lógica de validação/processamento do callback
- Redirecionamento após sucesso
- Tratamento de erros

**Referência:**
- Arquivo: `auth-callback.html` (na raiz)
- Será moved para `/backup/auth-callback.html.bak` após migração

### AuthCallbackPage Component

**Localização:** `src/web/pages/AuthCallbackPage.js`

**Responsabilidades:**
1. Capturar query params da URL (`?code=`, `?state=`, `?error=`)
2. Se existe `?error=`: exibir mensagem de erro
3. Se existe `?code=`: chamar `authService.handleOAuthCallback(code, state)`
4. Gerenciar loading state (mostrar "Processando login...")
5. Após sucesso: redirecionar para `/dashboard` com `router.push('/dashboard')`
6. Se falha: exibir erro amigável

**Pseudocódigo:**
```javascript
export class AuthCallbackPage {
  constructor(router, authService) {
    this.router = router;
    this.authService = authService;
  }

  async render() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const state = params.get('state');
    const error = params.get('error');

    if (error) {
      // Exibir erro
      return this.renderError(error);
    }

    if (!code) {
      return this.renderError('Código de autenticação não encontrado');
    }

    try {
      // Processar callback
      await this.authService.handleOAuthCallback(code, state);
      
      // Redirecionar para dashboard
      this.router.push('/dashboard');
    } catch (err) {
      this.renderError(err.message);
    }
  }

  renderError(message) {
    // Renderizar mensagem de erro amigável
  }
}
```

### AuthService Extensions

**Novos métodos necessários em `authService.js`:**

```javascript
// Métodos já existentes em História 1.2
export async function signIn(email, password) { /* ... */ }
export async function signInWithOAuth(provider) { /* ... */ }
export async function getSession() { /* ... */ }

// NOVO MÉTODO para esta história
export async function handleOAuthCallback(code, state) {
  // Supabase SDK já processa automaticamente
  // Verificar se session foi criada após redirect
  const { data, error } = await supabase.auth.getSession();
  
  if (error || !data.session) {
    throw new Error('Falha ao processar callback de autenticação');
  }
  
  return data.session;
}
```

[Source: architecture/05-api-specifications.md#autenticação]

### Variáveis de Ambiente (Dev)

**Configuração necessária em `.env` para desenvolvimento:**

```env
# URL da aplicação em desenvolvimento
DEV_REDIRECT_ORIGIN=http://localhost:3000

# Path do callback no dev server
DEV_REDIRECT_PATH=/__dev/oauth-callback

# Path para redirecionar após login (geralmente /dashboard)
DEV_POST_LOGIN_PATH=/dashboard

# Supabase (já deve estar configurado)
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=xxxxx
```

**Nota:** O arquivo `vite.config.js` já tem suporte para essas variáveis. Apenas verificar se estão documentadas.

[Source: vite.config.js lines 6-8, 93-110]

### Tratamento de Erros OAuth

**Erros Esperados:**
- `?error=access_denied` - Usuário recusou permissão
- `?error=invalid_client` - Erro na configuração do OAuth
- `?error=server_error` - Erro no servidor OAuth
- `?error=network_error` - Sem conexão
- Ausência de `?code=` - Callback inválido

**Feedback ao Usuário:**
- Mensagens claras em pt-br
- Sugerir ações (tentar novamente, voltar, etc)
- Link para voltar a `/login`

[Source: architecture/08-testing-reality.md#error-cases]

### Testability

**Dados de Teste:**
- URL com code válido: `http://localhost:3000/auth-callback?code=test123&state=state123`
- URL com erro: `http://localhost:3000/auth-callback?error=access_denied`
- Verificar se session é criada após processamento

**Teste Real (Manual):**
1. Configure OAuth Provider (Google) em Supabase
2. Registre redirect URI: `http://localhost:3000/auth-callback`
3. Clique "Login com Google" em `/login`
4. Autentique no Google
5. Verifique se redireciona para `/dashboard` (não para Vercel)

---

## Tasks / Subtasks

- [ ] **Task 1: Criar AuthCallbackPage Component** (AC: 1, 2)
  - [ ] Criar arquivo `src/web/pages/AuthCallbackPage.js`
  - [ ] Implementar extração de query params (code, state, error)
  - [ ] Validar presença de parâmetros necessários
  - [ ] Exibir "Processando autenticação..." durante processamento
  - [ ] Chamar `authService.handleOAuthCallback()` se code está presente
  - [ ] Renderizar página de erro se `?error=` ou falha no processamento

- [ ] **Task 2: Estender AuthService para OAuth Callback** (AC: 2)
  - [ ] Adicionar método `handleOAuthCallback(code, state)` em `authService.js`
  - [ ] Método deve validar que Supabase criou session
  - [ ] Retornar dados da sessão ou lançar erro descriptivo
  - [ ] Exportar função para uso em AuthCallbackPage

- [ ] **Task 3: Integrar AuthCallbackPage ao Roteador** (AC: 1, 3)
  - [ ] Registrar rota `/auth-callback` em `src/shared/router.js`
  - [ ] AuthCallbackPage deve renderizar quando usuário acessa `/auth-callback`
  - [ ] Após sucesso, rota chama `router.push('/dashboard')`

- [ ] **Task 4: Configurar Variáveis de Ambiente** (AC: 4)
  - [ ] Verificar se `.env` tem `DEV_REDIRECT_ORIGIN`, `DEV_REDIRECT_PATH`, `DEV_POST_LOGIN_PATH`
  - [ ] Adicionar ao `.env.example` com valores padrão
  - [ ] Documentar em `docs/` ou comentário em `.env`
  - [ ] Verificar que `vite.config.js` lê estas variáveis (já faz)
  - [ ] Testar com `DEV_REDIRECT_ORIGIN=http://localhost:3000`

- [ ] **Task 5: Verificar vite.config.js e dev-server.cjs** (AC: 4)
  - [ ] Confirmar que middleware de rewrite de redirect está ativo
  - [ ] Verificar que `__dev/oauth-callback` redireciona para `/auth-callback`
  - [ ] Testar que Location headers são reescritos corretamente (localhost, não Vercel)
  - [ ] Se necessário, corrigir ou adicionar lógica

- [ ] **Task 6: Testar Fluxo OAuth Manual** (AC: 2, 3, 4, 5)
  - [ ] Configure OAuth em Supabase (Google como exemplo)
  - [ ] Registre redirect URI: `http://localhost:3000/auth-callback`
  - [ ] `npm run dev` - iniciar servidor
  - [ ] Acesse `/login`
  - [ ] Clique "Login com Google" (ou provedor configurado)
  - [ ] Autentique no Google
  - [ ] Verifique se redireciona para `http://localhost:3000/dashboard` (não Vercel!)
  - [ ] Verifique se sessão foi criada (user está autenticado)
  - [ ] Teste fluxo de erro: acessar diretamente `/auth-callback?error=access_denied`

- [ ] **Task 7: Criar Testes de Integração/E2E** (AC: todos)
  - [ ] Criar arquivo `tests/integration/auth-callback.spec.js`
  - [ ] Teste: navegação para `/auth-callback?code=xxx` processa callback
  - [ ] Teste: sessão é criada após callback sucesso
  - [ ] Teste: erro no callback exibe mensagem amigável
  - [ ] Teste: ausência de code param exibe erro
  - [ ] Mock de `authService.handleOAuthCallback()` para testes
  - [ ] Testes devem passar sem chamadas reais ao Supabase

- [ ] **Task 8: Testes de Regressão** (AC: todos)
  - [ ] Executar `npm run build` - sem erros
  - [ ] Executar `npm run preview` - funciona
  - [ ] Testar fluxo de login normal (email/senha) ainda funciona
  - [ ] Testar navegação entre `/login` e `/auth-callback`
  - [ ] Verificar console - sem erros/warnings
  - [ ] Testar em diferentes navegadores se possível

- [ ] **Task 9: Backup e Documentação** (AC: 1)
  - [ ] Mover `auth-callback.html` para `/backup/auth-callback.html.bak`
  - [ ] Verificar referências quebradas
  - [ ] Documentar fluxo OAuth em `src/web/README.md`
  - [ ] Documentar variáveis de ambiente necessárias
  - [ ] Adicionar notas sobre configuração Supabase OAuth

---

## Testing

### Padrão de Testes para esta História

- **Framework:** Vitest (unit) + Playwright (E2E)
- **Localização:** `tests/integration/auth-callback.spec.js`
- **Mocks:** `authService.handleOAuthCallback()` deve ser mockado

### Testes Específicos Necessários

1. **Teste de Extração de Params:**
   - URL `?code=xxx&state=yyy` extrai corretamente
   - URL `?error=access_denied` detecta erro
   - URL sem params exibe erro

2. **Teste de Processamento Sucesso:**
   - Component chama `authService.handleOAuthCallback(code, state)`
   - Se sucesso, redireciona para `/dashboard`
   - Session é confirmada

3. **Teste de Processamento Erro:**
   - Se `?error=` presente, exibe mensagem erro
   - Se `handleOAuthCallback()` lança erro, exibe amigável
   - Link para voltar a `/login` está disponível

4. **Teste de Loading State:**
   - Texto "Processando..." exibido enquanto processa
   - Button/link desativado durante processamento
   - Estado restaurado após completo

5. **Teste de Rewrite de Redirect (Vite Config):**
   - Request para `/__dev/oauth-callback?code=xxx` redireciona para `/auth-callback?code=xxx`
   - Location header é reescrito de Vercel URL para localhost

[Source: architecture/08-testing-reality.md]

### Checklist Manual

- [ ] OAuth redirect chega em localhost:3000, não Vercel
- [ ] Code/state params são capturados
- [ ] Session é criada após sucesso
- [ ] Redirecionamento para /dashboard funciona
- [ ] Erros exibem mensagens claras
- [ ] Logout + login com OAuth funciona
- [ ] Build sem erros
- [ ] Preview funciona

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story created by Scrum Master | Bob (SM) |

---

## Dev Agent Record

*To be populated during implementation by the development agent.*

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

---

## QA Results

*To be populated by QA Agent after story implementation.*
