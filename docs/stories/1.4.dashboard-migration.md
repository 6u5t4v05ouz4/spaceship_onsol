# Story 1.4: Migração da Funcionalidade do Dashboard

## Status

Draft

---

## Story

**As a** Usuário logado,
**I want** acessar meu dashboard,
**so that** eu possa ver minhas informações principais.

---

## Acceptance Criteria

1. ✅ Conteúdo/funcionalidade de `dashboard.html` migrados para `DashboardPage`, protegida por login
2. ✅ Dados relevantes buscados do Supabase e exibidos corretamente
3. ✅ Navegação de/para dashboard funciona via roteador
4. ✅ Layout segue `UI_UX_DESIGN_SYSTEM.md`
5. ✅ Estados de carregamento (loading) exibidos durante busca de dados
6. ✅ Mensagens de erro exibidas se busca de dados falhar
7. ✅ Testes automatizados (integração/E2E básicos) criados para validar carregamento e exibição dos dados principais
8. ✅ Novos testes de regressão passam

---

## Dev Notes

### Previous Story Insights

- **História 1.1 completada:** Estrutura criada, roteador funciona
- **História 1.2 completada:** AuthService pronto, login funciona
- **História 1.3 completada:** OAuth callback funciona, user autenticado
- **Próximo passo:** DashboardPage precisa de AuthService para validar login
[Source: 1.1.new-structure-routing.md, 1.2.login-migration.md, 1.3.oauth-callback-migration.md]

### Dependência: Proteção por Login

**O Dashboard deve ser protegido:**
- Se usuário NÃO está autenticado → redirecionar para `/login`
- Se usuário está autenticado → renderizar DashboardPage

**Implementação:**
- Usar `authService.getSession()` no roteador antes de renderizar
- Se session existe e é válida → renderizar page
- Se session não existe ou expirou → redirecionar para `/login`

```javascript
// Em src/shared/router.js
page('/dashboard', async () => {
  const session = await authService.getSession();
  if (!session) {
    page.redirect('/login');
    return;
  }
  // Renderizar DashboardPage
});
```

[Source: architecture/05-api-specifications.md#autenticação]

### Dashboard HTML Atual (dashboard.html)

**Estrutura Atual:**
- Seção de estatísticas (Stats Cards): Level, XP, Coins, Wins
- Grid de naves/ships (NFTs do usuário)
- Grid de inventory/items
- Grid de achievements/badges
- Possível leaderboard

**Estilos CSS:**
- CSS variáveis já definidas (cores, spacing, fonts)
- Grid layouts responsivos
- Hover effects, transitions, sombras

**Dados Necessários (do Supabase):**
- Profile do usuário (username, avatar_url, etc)
- Game data (level, xp, coins, win_count)
- Inventory items (lista de items)
- Ships/NFTs (naves do usuário, possivelmente linked a Solana)
- Achievements (if schema exists)

[Source: dashboard.html lines 1-80, architecture/04-data-models.md]

### Dados do Dashboard (Supabase)

**Tabelas/Campos Esperados:**

1. **profiles table:**
   - `id` (FK to auth.users)
   - `username`
   - `avatar_url`
   - `bio` (opcional)
   - `created_at`, `updated_at`

2. **game_data table:**
   - `user_id` (FK to auth.users)
   - `level` (integer)
   - `experience` (numeric)
   - `coins` (numeric, currency)
   - `win_count` (integer)
   - `last_played` (timestamp)

3. **inventory table:**
   - `user_id` (FK)
   - `item_id` (FK or name)
   - `quantity` (integer)
   - `acquired_at` (timestamp)

4. **achievements table (optional):**
   - `user_id` (FK)
   - `achievement_id` (name or enum)
   - `unlocked_at` (timestamp)

5. **nft_ships table (optional, linked to Solana):**
   - `user_id` (FK)
   - `contract_address` (Solana)
   - `token_id` (NFT token ID)
   - `name`, `rarity`, `stats` (JSON)

[Source: architecture/04-data-models.md#principais-entidades]

### DashboardPage Component

**Localização:** `src/web/pages/DashboardPage.js`

**Responsabilidades:**
1. Receber `authService` e `router` no constructor
2. `render()`: buscar dados do Supabase, renderizar layout
3. Mostrar loading state enquanto busca dados
4. Exibir erro amigável se busca falhar
5. Renderizar seções: Profile, Stats, Ships, Inventory, Achievements
6. Atualizar dados periodicamente (opcional) ou permitir refresh manual

**Pseudocódigo:**
```javascript
export class DashboardPage {
  constructor(router, authService, supabaseClient) {
    this.router = router;
    this.authService = authService;
    this.supabase = supabaseClient;
    this.data = {};
  }

  async render() {
    try {
      this.showLoading();
      
      // Buscar dados do usuário
      const session = await this.authService.getSession();
      const userId = session.user.id;
      
      // Buscar profile
      this.data.profile = await this.fetchProfile(userId);
      
      // Buscar game data
      this.data.gameData = await this.fetchGameData(userId);
      
      // Buscar inventory
      this.data.inventory = await this.fetchInventory(userId);
      
      // Buscar ships/NFTs
      this.data.ships = await this.fetchShips(userId);
      
      // Buscar achievements (if exists)
      this.data.achievements = await this.fetchAchievements(userId);
      
      this.hideLoading();
      this.renderDashboard();
    } catch (error) {
      this.showError(error.message);
    }
  }

  async fetchProfile(userId) {
    const { data, error } = await this.supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();
    
    if (error) throw error;
    return data;
  }

  // ... outros fetch methods
}
```

### Serviço de Dashboard (Opcional)

Poderia criar `src/shared/services/dashboardService.js` para encapsular queries:

```javascript
export async function fetchDashboardData(supabase, userId) {
  // Buscar todos os dados necessários
  // Retornar objeto consolidado
}

export async function fetchUserProfile(supabase, userId) { /* ... */ }
export async function fetchGameData(supabase, userId) { /* ... */ }
export async function fetchInventory(supabase, userId) { /* ... */ }
export async function fetchShips(supabase, userId) { /* ... */ }
```

**Vantagem:** Código reutilizável para outras páginas
**Decisão:** Criar ou inline em DashboardPage? Deixa para o dev decidir.

[Source: architecture/06-integration-points.md#3-web-ui--supabase]

### UI/UX - Design System

**Seguir `docs/UI_UX_DESIGN_SYSTEM.md`:**

- **Paleta de cores:** Azul/Ciano para primária, escuro para bg
- **Tipografia:** Fontes especificadas em design system
- **Spacing:** Usar variáveis CSS (--spacing-xs, --spacing-md, etc)
- **Components:** Stat cards, grids, badges, loading spinners
- **Responsividade:** Mobile-first, breakpoints definidos
- **Acessibilidade:** Semantic HTML, ARIA labels, focus states

**Seções do Dashboard:**

1. **Header:** Username, Avatar, Logout button
2. **Stats Section:** Grid de 4+ cards (Level, XP, Coins, Wins)
3. **Ships Section:** Grid de naves/NFTs do usuário
4. **Inventory Section:** Grid de items (se disponível)
5. **Achievements Section:** Grid de badges/achievements (se disponível)
6. **Recent Activity:** Timeline de ações recentes (opcional)

[Source: dashboard.html CSS, UI_UX_DESIGN_SYSTEM.md]

### Error Handling

**Erros Esperados:**
- Supabase offline → "Erro ao carregar dados. Tente novamente."
- RLS policy denied → "Sem permissão para acessar dados"
- User data not found → "Dados do usuário não encontrados"
- Network timeout → "Conexão expirou. Tente novamente."

**Tratamento:**
- Exibir mensagem clara
- Botão "Tentar Novamente" para retry
- Botão "Voltar" para ir a `/login` se erro crítico

[Source: architecture/08-testing-reality.md#error-cases]

### Testability

**Mock Data para Testes:**
- User ID: `test-user-123`
- Profile: `{ username: 'testuser', avatar_url: '...' }`
- Game Data: `{ level: 5, xp: 1000, coins: 500, win_count: 3 }`
- Inventory: `[ { item_id: 1, quantity: 2 }, ... ]`
- Ships: `[ { name: 'Ship 1', rarity: 'rare', ... } ]`

**Testes necessários:**
- Loading state exibido enquanto busca
- Dados renderizados corretamente
- Erro tratado graciosamente
- Logout button funciona
- Rota protegida (sem auth → redirect)

[Source: architecture/08-testing-reality.md#phase-2-integration-tests]

---

## Tasks / Subtasks

- [ ] **Task 1: Criar DashboardService (Opcional)** (AC: 2)
  - [ ] Criar `src/shared/services/dashboardService.js` (ou inline, dev escolhe)
  - [ ] Implementar `fetchUserProfile(supabase, userId)`
  - [ ] Implementar `fetchGameData(supabase, userId)`
  - [ ] Implementar `fetchInventory(supabase, userId)`
  - [ ] Implementar `fetchShips(supabase, userId)` - pode retornar empty se NFT not linked
  - [ ] Implementar `fetchAchievements(supabase, userId)` - handle if table not exists
  - [ ] Tratamento de erros para cada query

- [ ] **Task 2: Criar DashboardPage Component** (AC: 1, 2, 5, 6)
  - [ ] Criar arquivo `src/web/pages/DashboardPage.js`
  - [ ] Constructor: receber `router`, `authService`, `supabase`
  - [ ] Implementar `render()` method
  - [ ] Buscar dados do Supabase usando service ou inline
  - [ ] Gerenciar loading state: exibir spinner/text enquanto carrega
  - [ ] Gerenciar error state: exibir mensagem se algo falhar
  - [ ] Exibir seção de perfil (username, avatar, logout button)
  - [ ] Exibir seção de stats (Level, XP, Coins, Wins em cards)
  - [ ] Exibir seção de ships/naves (grid responsivo)
  - [ ] Exibir seção de inventory (grid responsivo)
  - [ ] Exibir seção de achievements se dados existem

- [ ] **Task 3: Extrair CSS do Dashboard** (AC: 4)
  - [ ] Copiar/adaptar estilos de `dashboard.html` para `src/styles/pages/dashboard.css`
  - [ ] Ou importar estilos inline em DashboardPage (dev escolhe)
  - [ ] Garantir que estilos usam variáveis CSS do design system
  - [ ] Verificar responsividade em mobile (breakpoints)
  - [ ] Testar hover effects, transitions, visual feedback

- [ ] **Task 4: Proteger Rota do Dashboard** (AC: 1, 3)
  - [ ] Registrar rota `/dashboard` em `src/shared/router.js`
  - [ ] Implementar middleware de autenticação na rota
  - [ ] Se `!session` → redirecionar para `/login`
  - [ ] Se `session` válida → renderizar DashboardPage
  - [ ] Testar navegação: `/dashboard` funciona quando logado
  - [ ] Testar redirecionamento: sem login → `/login`

- [ ] **Task 5: Integração com AuthService** (AC: 1, 3)
  - [ ] Garantir que `authService.getSession()` funciona
  - [ ] Passar `authService` para DashboardPage
  - [ ] Logout button no dashboard funciona: `authService.signOut()` + redireciona para `/login`
  - [ ] Session persiste após reload de página

- [ ] **Task 6: Testar Fluxo Dashboard Manual** (AC: 2, 3, 4, 5, 6)
  - [ ] `npm run dev` - iniciar servidor
  - [ ] Tentar acessar `/dashboard` sem login → deve redirecionar para `/login`
  - [ ] Fazer login via email/senha
  - [ ] Acessar `/dashboard` → deve carregar dados
  - [ ] Verificar se spinner/loading exibido enquanto carrega
  - [ ] Verificar se dados exibem: username, level, xp, coins, ships (se existem)
  - [ ] Testar logout: botão logout → redireciona para `/login`
  - [ ] Verificar console: sem erros/warnings

- [ ] **Task 7: Criar Testes de Integração/E2E** (AC: 7)
  - [ ] Criar arquivo `tests/integration/dashboard.spec.js`
  - [ ] Teste: rota `/dashboard` protegida (sem auth → redirect)
  - [ ] Teste: loading state exibido enquanto busca dados
  - [ ] Teste: dados do Supabase renderizados corretamente
  - [ ] Teste: erro exibido se busca falhar
  - [ ] Teste: logout button funciona
  - [ ] Mock de `supabase.from().select()` para testes (não fazer chamadas reais)
  - [ ] Usar dados mock de profiles, game_data, inventory
  - [ ] Testes devem passar

- [ ] **Task 8: Testes de Regressão** (AC: 8)
  - [ ] Executar `npm run build` - sem erros
  - [ ] Executar `npm run preview` - funciona
  - [ ] Testar fluxo completo: login → dashboard → logout
  - [ ] Testar navegação: `/login` → `/dashboard` → `/`
  - [ ] Verificar console: sem erros/warnings críticos
  - [ ] Testar em diferentes navegadores se possível
  - [ ] Testar responsividade: mobile, tablet, desktop

- [ ] **Task 9: Backup e Documentação** (AC: 1)
  - [ ] Mover `dashboard.html` para `/backup/dashboard.html.bak`
  - [ ] Verificar referências quebradas
  - [ ] Documentar estrutura de DashboardPage em `src/web/README.md`
  - [ ] Documentar como buscar dados do Supabase
  - [ ] Adicionar guia de testes para futuros QAs

---

## Testing

### Padrão de Testes para esta História

- **Framework:** Vitest (unit) + Playwright (E2E)
- **Localização:** `tests/integration/dashboard.spec.js`
- **Mocks:** Supabase queries devem ser mockadas (não fazer chamadas reais)

### Testes Específicos Necessários

1. **Teste de Proteção de Rota:**
   - Acesso sem autenticação → redireciona para `/login`
   - Acesso com autenticação → renderiza dashboard

2. **Teste de Carregamento de Dados:**
   - Component exibe loading state
   - Busca profile, game_data, inventory, ships
   - Dados são renderizados após carregamento

3. **Teste de Renderização:**
   - Username e avatar exibidos
   - Stats cards mostram: Level, XP, Coins, Wins
   - Seção de ships renderiza (mesmo que vazia)
   - Seção de inventory renderiza (mesmo que vazia)

4. **Teste de Erro:**
   - Se Supabase retorna erro → mensagem clara exibida
   - Botão "Tentar Novamente" funciona
   - Usuário pode fazer logout mesmo em erro

5. **Teste de Logout:**
   - Botão logout funciona
   - User redireciona para `/login`
   - Session é destruída

6. **Teste de Regressão:**
   - Build sem erros
   - Preview funciona
   - Nenhum console error

[Source: architecture/08-testing-reality.md]

### Checklist Manual

- [ ] Dashboard protegido (redirecionamento sem auth)
- [ ] Loading state visível
- [ ] Dados carregam corretamente
- [ ] Stats exibem: Level, XP, Coins, Wins
- [ ] Ships grid exibe (mesmo que vazio)
- [ ] Inventory exibe (mesmo que vazio)
- [ ] Erro tratado graciosamente
- [ ] Logout funciona
- [ ] Responsivo em mobile
- [ ] Estilos seguem design system

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story created by Scrum Master | Bob (SM) |

---

## Dev Agent Record

*To be populated during implementation by the development agent.*

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

---

## QA Results

*To be populated by QA Agent after story implementation.*
