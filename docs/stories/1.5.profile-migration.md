# Story 1.5: Migração da Funcionalidade do Perfil

## Status

Draft

---

## Story

**As a** Usuário logado,
**I want** visualizar e editar meu perfil,
**so that** minhas informações estejam atualizadas.

---

## Acceptance Criteria

1. ✅ Conteúdo/funcionalidade de `profile.html` migrados para `ProfilePage`, protegida por login
2. ✅ Dados do perfil buscados e exibidos
3. ✅ Edição e salvamento no Supabase (via `profileService.js`) funcionam
4. ✅ Feedback de sucesso/erro ao salvar (seguir `UI_UX_DESIGN_SYSTEM.md`)
5. ✅ Layout segue `UI_UX_DESIGN_SYSTEM.md`
6. ✅ Estados de carregamento (loading) exibidos durante busca e salvamento
7. ✅ Validação de formulário implementada para campos editáveis
8. ✅ Testes automatizados (integração/E2E básicos) criados para validar visualização, edição e salvamento
9. ✅ Novos testes de regressão passam

---

## Dev Notes

### Previous Story Insights

- **História 1.1 completada:** Estrutura criada, roteador funciona
- **História 1.2 completada:** AuthService pronto, login funciona
- **História 1.3 completada:** OAuth callback funciona
- **História 1.4 completada:** DashboardPage pronto com dados Supabase
- **Nota:** ProfilePage é similar a DashboardPage mas com **edição** de dados
[Source: 1.2.login-migration.md, 1.4.dashboard-migration.md]

### Diferença entre Dashboard e Profile

**Dashboard (History 1.4):**
- Apenas **leitura** de dados
- Sem campos editáveis
- Mostra informações principais do jogo

**Profile (History 1.5) - NOVO:**
- **Edição** de dados (username, bio, avatar)
- Formulários com validação
- Salvamento de mudanças no Supabase
- Feedback de sucesso/erro

### Profile HTML Atual (profile.html)

**Estrutura:**
- Sidebar com avatar, username, info do usuário
- Main section com: Bio, Settings, Ships, Achievements
- Campos editáveis: username, bio, avatar (upload)
- Botões: Save, Cancel, Logout

**Estilos CSS:**
- Grid layout 2 colunas (sidebar + main)
- Avatar com upload
- Form fields com validação visual
- Feedback messages (success, error)

[Source: profile.html lines 1-100]

### Profile Data Model

**Tabela: profiles (já existe)**
```
profiles:
  - id (UUID, PK, FK to auth.users)
  - username (text, unique)
  - avatar_url (text, opcional)
  - bio (text, opcional)
  - created_at (timestamp)
  - updated_at (timestamp)
```

**Mudanças Possíveis (Schema):**
- Nenhuma prevista, mas se necessário adicionar campos, fazer via migration

[Source: architecture/04-data-models.md#data-models]

### ProfileService

**Localização:** `src/shared/services/profileService.js`

**Responsabilidades:**
1. Buscar profile do usuário (para edição)
2. Validar campos antes de salvar
3. Salvar alterações no Supabase
4. Fazer upload de avatar (se houver file input)

**Métodos Necessários:**

```javascript
// Buscar perfil
export async function getProfile(supabase, userId) {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', userId)
    .single();
  
  if (error) throw error;
  return data;
}

// Validar dados
export function validateProfileData(profile) {
  const errors = {};
  
  if (!profile.username || profile.username.trim().length < 3) {
    errors.username = 'Username deve ter pelo menos 3 caracteres';
  }
  if (profile.bio && profile.bio.length > 500) {
    errors.bio = 'Bio não pode exceder 500 caracteres';
  }
  
  return Object.keys(errors).length === 0 ? null : errors;
}

// Salvar perfil
export async function updateProfile(supabase, userId, profileData) {
  const errors = validateProfileData(profileData);
  if (errors) throw new Error(JSON.stringify(errors));
  
  const { data, error } = await supabase
    .from('profiles')
    .update(profileData)
    .eq('id', userId)
    .select()
    .single();
  
  if (error) throw error;
  return data;
}

// Upload de avatar (Supabase Storage)
export async function uploadAvatar(supabase, userId, file) {
  const fileName = `${userId}-${Date.now()}.${file.name.split('.').pop()}`;
  const { error: uploadError } = await supabase.storage
    .from('avatars')
    .upload(fileName, file, { upsert: true });
  
  if (uploadError) throw uploadError;
  
  // Gerar URL pública
  const { data } = supabase.storage
    .from('avatars')
    .getPublicUrl(fileName);
  
  return data.publicUrl;
}
```

[Source: architecture/06-integration-points.md#3-web-ui--supabase]

### ProfilePage Component

**Localização:** `src/web/pages/ProfilePage.js`

**Responsabilidades:**
1. Buscar perfil ao renderizar
2. Renderizar formulário com dados
3. Gerenciar estado de edição (modo leitura vs edição)
4. Validar formulário antes de salvar
5. Fazer upload de avatar se selecionado
6. Salvar alterações via `profileService`
7. Exibir feedback de sucesso/erro
8. Loading states

**Estados:**
- `viewing`: modo leitura, exibir dados
- `editing`: modo edição, campos habilitados
- `saving`: enviando dados, botão desativado
- `error`: erro ao salvar, exibir mensagem

**Pseudocódigo:**
```javascript
export class ProfilePage {
  constructor(router, authService, supabase) {
    this.router = router;
    this.authService = authService;
    this.supabase = supabase;
    this.state = 'viewing';
    this.profile = {};
    this.errors = {};
  }

  async render() {
    try {
      this.state = 'loading';
      const session = await this.authService.getSession();
      this.userId = session.user.id;
      
      this.profile = await profileService.getProfile(
        this.supabase, 
        this.userId
      );
      
      this.state = 'viewing';
      this.renderForm();
    } catch (error) {
      this.state = 'error';
      this.showError(error.message);
    }
  }

  toggleEdit() {
    this.state = this.state === 'viewing' ? 'editing' : 'viewing';
    this.renderForm();
  }

  async handleSave() {
    this.errors = profileService.validateProfileData(this.profile);
    
    if (Object.keys(this.errors).length > 0) {
      this.renderForm(); // Mostrar erros
      return;
    }

    try {
      this.state = 'saving';
      
      // Upload avatar se mudou
      if (this.avatarFile) {
        const avatarUrl = await profileService.uploadAvatar(
          this.supabase,
          this.userId,
          this.avatarFile
        );
        this.profile.avatar_url = avatarUrl;
      }

      // Salvar perfil
      this.profile = await profileService.updateProfile(
        this.supabase,
        this.userId,
        this.profile
      );

      this.state = 'viewing';
      this.showSuccess('Perfil atualizado com sucesso!');
      this.renderForm();
    } catch (error) {
      this.state = 'error';
      this.showError(error.message);
    }
  }
}
```

### Upload de Avatar (Storage)

**Estrutura:**
1. User seleciona imagem via file input
2. Script valida: tamanho max 5MB, formato (jpg, png)
3. Faz upload para `supabase.storage.from('avatars')`
4. Obtém URL pública
5. Atualiza `avatar_url` no profiles table
6. Exibe nova imagem

**Validação:**
- Max 5MB
- Formatos: jpg, jpeg, png, webp
- Mensagens de erro claras

[Source: architecture/06-integration-points.md#supabase-storage]

### UI/UX - Design System

**Layout Perfil:**

1. **Header:** Username, Avatar, Edit/Save buttons
2. **Avatar Section:** 
   - Exibir avatar atual
   - File input para trocar
   - Preview da nova imagem (antes de salvar)
3. **Form Fields:**
   - Username (text input, required)
   - Bio (textarea, max 500 chars, opcional)
   - Email (read-only, mostrar user email)
4. **Buttons:**
   - Edit (toggle modo edição)
   - Save (salvar mudanças, disabled em edição)
   - Cancel (descartar mudanças)
   - Logout
5. **Feedback:**
   - Success message: "Perfil atualizado com sucesso!"
   - Error messages: por campo ou geral
   - Loading spinner ao salvar

[Source: profile.html CSS, UI_UX_DESIGN_SYSTEM.md]

### Validação de Formulário

**Campos:**

| Campo | Tipo | Validação |
|-------|------|-----------|
| Username | text | Min 3 chars, Max 50 chars, alphanumeric + underscore |
| Bio | textarea | Max 500 chars (opcional) |
| Avatar | file | Max 5MB, jpg/png/webp (opcional) |
| Email | text | Read-only (from auth.users) |

**Erro Handling:**
- Mostrar erros por campo (inline)
- Submit button desativado se há erros
- Mensagem geral de erro ao salvar

[Source: architecture/08-testing-reality.md#error-cases]

### RLS Policies (Verificação)

**Verificar se existem policies em `database-rls-policies.sql`:**

```sql
-- Usuário só pode ver/editar seu próprio perfil
CREATE POLICY "Users can view own profile"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);
```

Se não existem, a história de ProfilePage funcionará mas sem segurança.
Pode ser adicionado como subtask ou deixar para futura correção.

[Source: architecture/04-data-models.md#rls-policies]

### Testability

**Mock Data:**
- User ID: `test-user-123`
- Profile:
  ```json
  {
    "id": "test-user-123",
    "username": "testuser",
    "avatar_url": "https://...",
    "bio": "Test bio",
    "created_at": "2025-01-01T00:00:00",
    "updated_at": "2025-10-18T00:00:00"
  }
  ```

**Testes Necessários:**
- Carregar perfil ao render
- Editar fields
- Validar formulário
- Salvar com sucesso
- Erro ao salvar
- Upload avatar
- Logout

[Source: architecture/08-testing-reality.md#phase-2-integration-tests]

---

## Tasks / Subtasks

- [ ] **Task 1: Criar ProfileService** (AC: 3, 7)
  - [ ] Criar arquivo `src/shared/services/profileService.js`
  - [ ] Implementar `getProfile(supabase, userId)` - buscar dados
  - [ ] Implementar `validateProfileData(profile)` - validar campos
  - [ ] Implementar `updateProfile(supabase, userId, profileData)` - salvar
  - [ ] Implementar `uploadAvatar(supabase, userId, file)` - upload storage
  - [ ] Adicionar tratamento de erros com mensagens claras
  - [ ] Exportar todas as funções

- [ ] **Task 2: Criar ProfilePage Component** (AC: 1, 2, 5, 6)
  - [ ] Criar arquivo `src/web/pages/ProfilePage.js`
  - [ ] Constructor: receber `router`, `authService`, `supabase`
  - [ ] Implementar `render()` - buscar e exibir perfil
  - [ ] Gerenciar estados: viewing, editing, saving, error
  - [ ] Renderizar formulário com campos: username, bio, avatar
  - [ ] Exibir loading spinner enquanto busca/salva
  - [ ] Toggle Edit/Save buttons

- [ ] **Task 3: Implementar Validação** (AC: 7)
  - [ ] Validação de username (min 3 chars, max 50)
  - [ ] Validação de bio (max 500 chars, opcional)
  - [ ] Validação de avatar (max 5MB, formato correto)
  - [ ] Exibir erros inline nos campos
  - [ ] Desabilitar botão save se há erros
  - [ ] Mensagem de validação clara

- [ ] **Task 4: Implementar Salvamento** (AC: 3, 4, 6)
  - [ ] Botão Save funciona
  - [ ] Upload avatar se arquivo selecionado
  - [ ] Atualiza perfil no Supabase
  - [ ] Loading state enquanto salva
  - [ ] Exibe sucesso: "Perfil atualizado!"
  - [ ] Exibe erro se algo falhar
  - [ ] Volta para modo viewing após salvar
  - [ ] Botão Cancel descarta mudanças

- [ ] **Task 5: Extrair CSS do Perfil** (AC: 5)
  - [ ] Copiar/adaptar estilos de `profile.html` para `src/styles/pages/profile.css`
  - [ ] Ou importar estilos inline em ProfilePage (dev escolhe)
  - [ ] Garantir que estilos usam variáveis CSS
  - [ ] Verificar responsividade
  - [ ] Testar hover effects, transitions

- [ ] **Task 6: Proteger Rota do Perfil** (AC: 1)
  - [ ] Registrar rota `/profile` em `src/shared/router.js`
  - [ ] Implementar middleware de autenticação
  - [ ] Se `!session` → redirecionar para `/login`
  - [ ] Se `session` válida → renderizar ProfilePage
  - [ ] Testar navegação: `/profile` funciona quando logado
  - [ ] Testar redirecionamento: sem login → `/login`

- [ ] **Task 7: Testar Fluxo Profile Manual** (AC: 2, 3, 4, 5, 6)
  - [ ] `npm run dev` - iniciar servidor
  - [ ] Acessar `/profile` sem login → redirecionar `/login`
  - [ ] Fazer login
  - [ ] Acessar `/profile` → carregar dados
  - [ ] Verificar loading state
  - [ ] Clique Edit → formulário fica editável
  - [ ] Editar username, bio
  - [ ] Clique Save → salva no Supabase
  - [ ] Verificar sucesso message
  - [ ] Reload página → dados permanecem
  - [ ] Testar upload avatar
  - [ ] Testar validação: username vazio, bio > 500 chars
  - [ ] Testar cancel: descartar mudanças

- [ ] **Task 8: Criar Testes de Integração/E2E** (AC: 8)
  - [ ] Criar arquivo `tests/integration/profile.spec.js`
  - [ ] Teste: rota protegida (sem auth → redirect)
  - [ ] Teste: carregar perfil ao render
  - [ ] Teste: modo edição ativa/desativa
  - [ ] Teste: validação de username
  - [ ] Teste: salvar perfil com sucesso
  - [ ] Teste: erro ao salvar exibido
  - [ ] Teste: upload avatar (mock file)
  - [ ] Teste: cancel descarta mudanças
  - [ ] Mock de profileService para não fazer chamadas reais
  - [ ] Testes devem passar

- [ ] **Task 9: Testes de Regressão** (AC: 9)
  - [ ] Executar `npm run build` - sem erros
  - [ ] Executar `npm run preview` - funciona
  - [ ] Testar fluxo completo: login → dashboard → profile → logout
  - [ ] Testar navegação entre rotas
  - [ ] Verificar console - sem erros/warnings críticos
  - [ ] Testar responsividade: mobile, tablet, desktop
  - [ ] Testar em diferentes navegadores

- [ ] **Task 10: Backup e Documentação** (AC: 1)
  - [ ] Mover `profile.html` para `/backup/profile.html.bak`
  - [ ] Verificar referências quebradas
  - [ ] Documentar ProfilePage em `src/web/README.md`
  - [ ] Documentar profileService
  - [ ] Adicionar guia de testes

---

## Testing

### Padrão de Testes para esta História

- **Framework:** Vitest (unit) + Playwright (E2E)
- **Localização:** `tests/integration/profile.spec.js`
- **Mocks:** profileService, uploadAvatar, Supabase queries

### Testes Específicos Necessários

1. **Teste de Carregamento:**
   - Component busca perfil ao render
   - Dados exibem corretamente

2. **Teste de Edição:**
   - Toggle Edit ativa/desativa campos
   - Pode editar username, bio
   - File input funciona

3. **Teste de Validação:**
   - Username < 3 chars → erro
   - Bio > 500 chars → erro
   - Avatar > 5MB → erro
   - Erros exibem inline

4. **Teste de Salvamento:**
   - Save envia dados ao Supabase
   - Success message exibida
   - Volta para modo viewing

5. **Teste de Erro:**
   - Se Supabase falha → erro exibido
   - Retry possível
   - Dados não são perdidos

6. **Teste de Regressão:**
   - Build sem erros
   - Preview funciona
   - Nenhum console error

[Source: architecture/08-testing-reality.md]

### Checklist Manual

- [ ] Perfil protegido (redirecionamento)
- [ ] Loading state ao carregar
- [ ] Dados exibem corretamente
- [ ] Edit toggle funciona
- [ ] Validação de campos
- [ ] Save funciona
- [ ] Avatar upload funciona
- [ ] Success/error messages claros
- [ ] Cancel descarta mudanças
- [ ] Responsivo em mobile

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story created by Scrum Master | Bob (SM) |

---

## Dev Agent Record

*To be populated during implementation by the development agent.*

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes List

TBD

### File List

TBD

---

## QA Results

*To be populated by QA Agent after story implementation.*
